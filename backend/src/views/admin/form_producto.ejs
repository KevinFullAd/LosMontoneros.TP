<!-- backend/src/views/admin/form_producto.ejs -->
<header class="mb-4 border-bottom pb-2">
    <h2 class="h4 mb-0">
        <%= producto ? 'Editar producto' : 'Nuevo producto' %>
    </h2>
    <p class="text-muted mb-0">
        <%= producto ? 'Modifica los datos del producto seleccionado'
            : 'Completa los datos para registrar un nuevo producto' %>
    </p>
</header>

<form id="productoForm" class="card shadow-sm p-4">
    <div class="mb-3">
        <label class="form-label">Nombre</label>
        <input type="text" name="nombre" class="form-control" value="<%= producto?.nombre || '' %>" required>
    </div>

    <div class="mb-3">
        <label class="form-label">Descripción</label>
        <textarea name="descripcion" class="form-control" rows="3"><%= producto?.descripcion || '' %></textarea>
    </div>

    <div class="mb-3">
        <label class="form-label">Precio</label>
        <input type="number" step="0.01" name="precio" class="form-control" value="<%= producto?.precio || '' %>"
            required>
    </div>

    <div class="mb-3">
        <label class="form-label">Imagen (URL)</label>
        <input type="text" name="imagen" class="form-control" value="<%= producto?.imagen || '' %>">
    </div>

    <div class="mb-3">
        <label class="form-label">Categoría</label>
        <input type="text" name="categoria" class="form-control" value="<%= producto?.categoria || '' %>">
    </div>

    <div class="text-end mt-4">
        <button type="submit" class="btn btn-success">
            <i class="bi bi-save me-1"></i>
            <%= producto ? 'Guardar cambios' : 'Crear' %>
        </button>
        <a href="/admin/dashboard" class="btn btn-outline-secondary">Cancelar</a>
    </div>
</form>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("productoForm");

        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const data = Object.fromEntries(new FormData(form).entries());
            const isEdit = !!<%- producto ? 1 : 0 %>;


            const url = isEdit
                ? `/api/admin/productos/<%= producto?.id %>`
                : `/api/admin/productos`;

            const method = isEdit ? "PUT" : "POST";

            try {
                const res = await fetch(url, {
                    method,
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data),
                });

                const result = await res.json();

                if (res.ok) {
                    await Swal.fire({
                        icon: "success",
                        title: "Éxito",
                        text: result.message || "Producto guardado correctamente",
                        confirmButtonColor: "#3085d6",
                    });
                    window.location.href = "/admin/dashboard";
                } else {
                    Swal.fire({
                        icon: "error",
                        title: "Error",
                        text: result.error || "No se pudo guardar el producto",
                        confirmButtonColor: "#d33",
                    });
                }
            } catch (err) {
                Swal.fire({
                    icon: "error",
                    title: "Error interno",
                    text: "Ocurrió un error en el servidor.",
                });
            }
        });
    });
</script>